{% extends 'base.html' %}

{% block title %}Chat - NetCafe{% endblock %}

{% block head %}
  <style>
    /* Admin-specific list styles kept here */
    .messenger { display:flex; gap:12px; }
    .msger-list { width:28%; border:1px solid #ccc; height:420px; overflow:auto; padding:8px; }
    .msger-item { padding:8px; cursor:pointer; border-bottom:1px solid #eee; position:relative; }
    .notify-badge { position:absolute; right:8px; top:10px; background:#e53935; color:#fff; width:18px; height:18px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:12px; line-height:1; }
    .msger-item.notify { background:#fff5f5; }
    .msger-item.selected { background:#f0f8ff; }
    .msger-chat { flex:1; border:1px solid #ccc; height:420px; display:flex; flex-direction:column; }
    .msger-messages { flex:1; padding:10px; overflow-y:auto; }
    .msger-input { padding:8px; border-top:1px solid #eee; }
    .online-dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:6px; background:gray; }
    .online-dot.on { background:green; }
  </style>
{% endblock %}

{% block content %}
  <div class="card p-3">
    <h2>Phòng chat <small class="text-muted">({{ role }}) - {{ username }}</small></h2>
    <div id="chatMeta"
         data-user-id="{{ user_id }}"
         data-role="{{ role }}"
         data-target-user-id="{{ target_user_id if target_user_id else '' }}"
         style="display:none;"></div>

    {% if role == 'admin' %}
      <div class="messenger mt-3">
        <div class="msger-list" id="msgerList">
          {% for u in users %}
          <div class="msger-item {% if target_user_id and u.id==target_user_id %}selected{% endif %}" data-user-id="{{ u.id }}">
            <span class="online-dot {% if u.is_online==1 %}on{% endif %}" id="dot-{{ u.id }}"></span>
            <span class="msger-username">{{ u.username }}</span>
            <span class="notify-badge" id="badge-{{ u.id }}" style="display:none"></span>
          </div>
          {% endfor %}
        </div>

        <div class="msger-chat">
          <div class="msger-messages" id="chatBox">
            {% for msg in messages %}
            <div class="msg-row {% if msg.from_user_id == user_id %}outgoing{% else %}incoming{% endif %}">
              <div class="msg-bubble {% if msg.from_user_id == user_id %}outgoing{% else %}incoming{% endif %}">
                <b>[{{ msg.sender_role }} - {{ msg.sender_name }}]</b>
                <div>{{ msg.content }}</div>
                <small class="msg-time">{{ msg.created_at }}</small>
              </div>
            </div>
            {% endfor %}
          </div>

          <div class="msger-input">
            <textarea id="messageInput" rows="3" class="form-control" required></textarea>
            <div class="text-end mt-2"><button id="sendBtn" class="btn btn-primary">Gửi</button></div>
          </div>
        </div>
      </div>
    {% else %}
      <div id="chatBox" class="mt-3" style="border:1px solid #ddd;padding:12px;height:320px;overflow-y:auto;">
        {% for msg in messages %}
        <div class="msg-row {% if msg.from_user_id == user_id %}outgoing{% else %}incoming{% endif %}">
          <div class="msg-bubble {% if msg.from_user_id == user_id %}outgoing{% else %}incoming{% endif %}">
            <b>[{{ msg.sender_role }} - {{ msg.sender_name }}]</b>
            <div>{{ msg.content }}</div>
            <small class="msg-time">{{ msg.created_at }}</small>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="mt-3">
        <textarea id="messageInput" rows="3" class="form-control" required></textarea>
        <div class="text-end mt-2"><button id="sendBtn" class="btn btn-primary">Gửi</button></div>
      </div>
    {% endif %}

    <div class="mt-3">
      {% if role == 'admin' %}
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('admin_dashboard') }}">Về trang Admin</a>
      {% else %}
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('user_dashboard') }}">Về trang User</a>
      {% endif %}
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('logout') }}">Đăng xuất</a>
    </div>
  </div>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script>
    const chatMeta = document.getElementById('chatMeta');
    const userId = chatMeta ? (chatMeta.dataset.userId ? parseInt(chatMeta.dataset.userId) : null) : null;
    const role = chatMeta ? (chatMeta.dataset.role || null) : null;
    let targetUserId = chatMeta ? (chatMeta.dataset.targetUserId ? parseInt(chatMeta.dataset.targetUserId) : null) : null;
    const socket = io();

    socket.on('connect', function(){
      let roleValue = role || (document.getElementById('msgerList') ? 'admin' : 'user');
      if(roleValue === 'admin') socket.emit('join', {user_id: userId, role: roleValue});
      else socket.emit('join', {user_id: userId, role: roleValue, target_user_id: targetUserId});
    });

    socket.on('joined', function(info){ console.log('[socket] joined', info); });

    socket.on('user_active', function(p){ try{ const item = document.querySelector('.msger-item[data-user-id="' + p.user_id + '"]'); if(item){ const badge = document.getElementById('badge-' + p.user_id); if(badge){ badge.style.display = 'inline-flex'; badge.innerText = '•'; } item.classList.add('notify'); } }catch(e){console.error(e)} });

    const chatBox = document.getElementById('chatBox');
    const sendBtn = document.getElementById('sendBtn');
    const messageInput = document.getElementById('messageInput');
    const seenMessageIds = new Set();

    function appendMessage(m){
      if(m && m.id){ if(seenMessageIds.has(m.id)) return; seenMessageIds.add(m.id); }
      let side = 'incoming';
      if(m && typeof m.from_user_id !== 'undefined') side = (m.from_user_id === userId) ? 'outgoing' : 'incoming';
      const row = document.createElement('div'); row.className = 'msg-row ' + side;
      const bubble = document.createElement('div'); bubble.className = 'msg-bubble ' + side;
      const senderLabel = (m && (m.sender_role || m.sender_name)) ? `[${m.sender_role || ''} - ${m.sender_name || ''}]` : '';
      bubble.innerHTML = `<strong>${senderLabel}</strong><div>${m.content || ''}</div><small class="msg-time">${m.created_at || ''}</small>`;
      row.appendChild(bubble); if(chatBox) { chatBox.appendChild(row); chatBox.scrollTop = chatBox.scrollHeight; }
    }

    socket.on('new_message', function(m){
      const otherId = (m.from_user_id == userId) ? m.to_user_id : m.from_user_id;
      if(role === 'admin'){
        if(!targetUserId) return; if(otherId == targetUserId || m.to_user_id == targetUserId || m.from_user_id == targetUserId) appendMessage(m);
      } else appendMessage(m);
    });

    socket.on('messages', function(payload){ if(chatBox){ chatBox.innerHTML = ''; seenMessageIds.clear(); payload.messages.forEach(function(m){ appendMessage(m); }); } });

    socket.on('clear_chat', function(data){ if(role === 'admin'){ if(data.user_id == targetUserId){ if(chatBox) chatBox.innerHTML = ''; alert('Đoạn chat với user đã bị xoá (user đã đăng xuất).'); } const item = document.querySelector('.msger-item[data-user-id="' + data.user_id + '"]'); if(item) item.remove(); } else { if(data.user_id == userId){ if(chatBox) chatBox.innerHTML = ''; alert('Đoạn chat của bạn đã bị xoá khi đăng xuất.'); } } });

    sendBtn && sendBtn.addEventListener('click', function(e){ e.preventDefault(); const content = messageInput.value.trim(); if(!content) return; let toId = null; if(role === 'admin'){ if(!targetUserId){ const selItem = document.querySelector('.msger-item.selected') || document.querySelector('.msger-item'); if(selItem) targetUserId = parseInt(selItem.getAttribute('data-user-id')); } if(!targetUserId){ alert('Chưa chọn user để chat'); return; } toId = targetUserId; } const payload = {from_user_id: userId, to_user_id: toId, content: content}; socket.emit('send_message', payload); messageInput.value = ''; sendBtn.disabled = true; setTimeout(() => sendBtn.disabled = false, 500); });

    const msgerList = document.getElementById('msgerList');
    if(msgerList){
      msgerList.addEventListener('click', function(e){ let el = e.target; while(el && !el.classList.contains('msger-item')) el = el.parentElement; if(!el) return; const newId = parseInt(el.getAttribute('data-user-id')); const prev = targetUserId; if(prev === newId) return; document.querySelectorAll('.msger-item').forEach(i=>i.classList.remove('selected')); el.classList.add('selected'); targetUserId = newId; socket.emit('switch_user', {prev_user_id: prev, new_user_id: newId}); try{ const badge = document.getElementById('badge-' + newId); if(badge){ badge.style.display='none'; badge.innerText=''; } const item = document.querySelector('.msger-item[data-user-id="' + newId + '"]'); if(item) item.classList.remove('notify'); }catch(e){console.error(e)} });
    }

    socket.on('user_status', function(p){ try{ const dot = document.getElementById('dot-' + p.user_id); if(dot){ if(p.is_online == 1) dot.classList.add('on'); else dot.classList.remove('on'); } }catch(e){console.error(e)} });
  </script>
{% endblock %}

