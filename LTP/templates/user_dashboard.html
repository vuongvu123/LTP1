{% extends 'base.html' %}

{% block title %}Trang User - NetCafe{% endblock %}

{% block content %}
  <div class="card p-4" data-user-id="{{ user.id }}">
    <h2>Xin chào, {{ user.username }} <small class="text-muted">(User)</small></h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mt-3">
          {% for category, message in messages %}
            <div class="alert alert-{{ 'success' if category=='success' else 'danger' }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="row mt-3">
      <div class="col-md-6">
        <!-- <p>Số dư hiện tại: <b id="balance">{{ user.balance }}</b></p> -->
        <p>Thời gian còn lại: <b><span id="time-left" data-seconds="{{ seconds_left }}">--:--:--</span></b></p>
        <p>Trạng thái: <span class="fw-bold">{{ 'Đang online' if user.is_online else 'Offline' }}</span></p>
      </div>
      <div class="col-md-6 text-end">
        <a class="btn btn-outline-secondary" href="{{ url_for('chat') }}">Chat với admin</a>
      </div>
    </div>

    <hr />

    <h5>Gửi yêu cầu nạp tiền</h5>
    <form method="post" action="{{ url_for('user_request_topup') }}" class="row g-2 align-items-center">
      <div class="col-auto">
        <input class="form-control" type="number" name="amount" min="1" required />
      </div>
      <div class="col-auto">
        <button class="btn btn-primary" type="submit">Gửi yêu cầu</button>
      </div>
    </form>

    <h5 class="mt-4">Lịch sử yêu cầu</h5>
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr><th>ID</th><th>Số tiền</th><th>Trạng thái</th><th>Thời gian</th></tr>
        </thead>
        <tbody>
          {% for req in requests_list %}
          <tr>
            <td>{{ req.id }}</td>
            <td>{{ req.amount }}</td>
            <td>{{ req.status }}</td>
            <td>{{ req.created_at }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script>
    const socket = io();
    const myId = parseInt(document.querySelector('.card').getAttribute('data-user-id') || '0', 10);
    socket.on('connect', function(){
      socket.emit('join', {user_id: myId, role: 'user'});
    });
    socket.on('new_message', function(m){
      if(m.to_user_id == myId || m.from_user_id == myId){
        // small notification
        if(typeof window !== 'undefined'){
          // use Bootstrap toast or simple alert fallback
          alert(m.content);
        }
      }
    });

    // listen for time updates from server
    socket.on('time_update', function(p){
      if(!p || !p.user_id) return;
      if(parseInt(p.user_id,10) !== myId) return;
      // update balance and time-left
      const balEl = document.getElementById('balance');
      const timeEl = document.getElementById('time-left');
      if(balEl && typeof p.balance !== 'undefined'){
        balEl.textContent = Math.round(p.balance);
      }
      if(timeEl && typeof p.seconds_left !== 'undefined'){
        timeEl.setAttribute('data-seconds', p.seconds_left);
        timeEl.textContent = formatHMS(p.seconds_left);
      }
      // handle statuses
      if(p.status === 'OUT'){
        alert('Bạn đã hết tiền!');
        window.location = '{{ url_for("login") }}';
      } else if(p.status === 'PAUSED'){
        // clear client timer so it doesn't keep counting down while logged out
        try{
          if(timeEl){
            const tid = parseInt(timeEl.getAttribute('data-tid')||'0', 10);
            if(tid){ clearInterval(tid); timeEl.removeAttribute('data-tid'); }
          }
        }catch(e){ }
      }
    });

    // countdown timer
    function formatHMS(sec){ sec = Number(sec); if(isNaN(sec)||sec<=0) return '00:00:00'; const h = Math.floor(sec/3600); const m = Math.floor((sec%3600)/60); const s = Math.floor(sec%60); return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
    (function startTimer(){
      const el = document.getElementById('time-left');
      if(!el) return;
      let sec = parseInt(el.getAttribute('data-seconds')||'0',10);
      el.textContent = formatHMS(sec);
      if(sec<=0) return;
      // store interval id so we can clear it from other handlers
      const tid = setInterval(()=>{
        sec = sec - 1;
        if(sec<=0){ el.textContent='00:00:00'; clearInterval(tid); el.removeAttribute('data-tid'); }
        else el.textContent = formatHMS(sec);
      }, 1000);
      el.setAttribute('data-tid', tid);
    })();
  </script>
{% endblock %}

