{% extends 'base.html' %}

{% block title %}Admin Dashboard - NetCafe{% endblock %}

{% block content %}
  <div class="card p-4">
    <h2>Xin chào {{ session.username }} <small class="text-muted">(Admin)</small></h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mt-3">
          {% for category, message in messages %}
            <div class="alert alert-{{ 'success' if category=='success' else 'danger' }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <hr />

    <div class="row mb-4">
      <div class="col-12">
        <h5>Danh sách User</h5>
        <div class="table-responsive">
          <table class="table table-bordered align-middle">
            <thead class="table-light"><tr><th>ID</th><th>User</th><th>Số dư (đ)</th><th>Thời gian còn lại</th><th>Trạng thái</th><th>Nạp tiền</th></tr></thead>
            <tbody>
            {% for u in users %}
              <tr>
                <td>{{ u.id }}</td>
                <td>{{ u.username }}</td>
                <td>{{ '%.0f' % u.balance }}</td>
                <td>
                  <span id="time-left-{{ u.id }}" 
                        data-seconds="{{ u.seconds_left }}" 
                        data-status="{{ u.is_online }}">
                    --:--:--
                  </span>
                </td>
                <td id="status-{{ u.id }}">
                  {% if u.is_online == 1 %}
                    <span class="text-success fw-bold">Online</span>
                  {% else %}
                    <span class="text-muted">Offline</span>
                  {% endif %}
                </td>
                <td>
                  <form method="post" action="{{ url_for('admin_topup', user_id=u.id) }}" class="d-flex gap-2">
                    <input class="form-control form-control-sm" type="number" name="amount" min="1000" placeholder="Số tiền" required />
                    <button class="btn btn-sm btn-outline-primary" type="submit">Nạp</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card p-3 h-100">
          <h5>⭐ Tạo tài khoản User mới</h5>
          <form method="post" action="{{ url_for('admin_create_user') }}" class="d-flex gap-2">
            <input class="form-control" type="text" name="username" placeholder="Username" required />
            <input class="form-control" type="password" name="password" placeholder="Password" required />
            <button class="btn btn-primary" type="submit">Tạo</button>
          </form>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3 h-100 text-center">
          <h5>Chat</h5>
          <p class="text-muted">Mở cửa sổ chat để trò chuyện với User</p>
          <div class="d-flex gap-2 justify-content-center">
            <select id="chat-select-user" class="form-select form-select-sm" style="max-width:180px;">
              {% for u in users %}
                <option value="{{ u.id }}">{{ u.username }}</option>
              {% endfor %}
            </select>
            <button id="open-chat-btn" class="btn btn-sm btn-outline-primary">Mở chat</button>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3 h-100">
          <h5>Nạp tiền nhanh</h5>
          <p class="text-muted">Chọn user và nhập số tiền để nạp nhanh</p>
          <form id="quick-topup-form" method="post" class="d-flex gap-2 align-items-center">
            <select id="topup-select-user" class="form-select form-select-sm" style="max-width:160px;">
              {% for u in users %}
                <option value="{{ u.id }}">{{ u.username }}</option>
              {% endfor %}
            </select>
            <input id="topup-amount" class="form-control form-control-sm" type="number" name="amount" min="1000" placeholder="Số tiền" style="max-width:120px;" required />
            <button class="btn btn-sm btn-outline-success" type="submit">Nạp</button>
          </form>
        </div>
      </div>
    </div>

    <hr />

    <h5>Yêu cầu nạp tiền từ User</h5>
    <div class="table-responsive">
      <table class="table table-striped">
        <thead><tr><th>ID</th><th>User</th><th>Số tiền</th><th>Trạng thái</th><th>Thời gian</th><th>Hành động</th></tr></thead>
        <tbody id="requestsBody">
        {% for req in requests_list %}
          <tr id="req-{{ req.id }}">
            <td>{{ req.id }}</td>
            <td>{{ req.username }}</td>
            <td>{{ req.amount }}</td>
            <td class="status-cell">{{ req.status }}</td>
            <td>{{ req.created_at }}</td>
            <td class="action-cell">{% if req.status == 'pending' %}<a href="{{ url_for('admin_approve_request', req_id=req.id) }}">Duyệt &amp; Nạp</a>{% else %}✔ Đã xử lý{% endif %}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-3">
      <a class="btn btn-outline-secondary" href="{{ url_for('chat') }}">Chat với User</a>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script id="server-data" type="application/json">{{ {'user_id': session.user_id, 'role': 'admin'} | tojson }}</script>
  
  <script>
    const socket = io();
    const serverData = JSON.parse(document.getElementById('server-data').textContent || 'null');
    
    // Join rooms
    socket.on('connect', function(){ socket.emit('join', serverData); });

    // ==========================================
    // LOGIC ĐỒNG HỒ ĐẾM NGƯỢC THÔNG MINH
    // ==========================================
    var userTimers = {}; // Lưu trữ { seconds: number, status: 0|1 }

    // Hàm format giây thành HH:MM:SS
    function formatHMS(sec){ 
      sec = Number(sec); 
      if(isNaN(sec) || sec < 0) sec = 0; 
      const h = Math.floor(sec/3600); 
      const m = Math.floor((sec%3600)/60); 
      const s = Math.floor(sec%60); 
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; 
    }

    // Hàm cập nhật giao diện 1 user cụ thể
    function updateDisplay(uid) {
        const el = document.getElementById('time-left-' + uid);
        if (el && userTimers[uid]) {
            el.innerText = formatHMS(userTimers[uid].seconds);
        }
    }

    // Khởi tạo dữ liệu từ HTML khi trang load
    function initTimers() {
        const els = document.querySelectorAll('[id^="time-left-"]');
        els.forEach(function(el){
            let uid = el.id.split('-')[2];
            let sec = parseInt(el.getAttribute('data-seconds') || '0', 10);
            let stat = parseInt(el.getAttribute('data-status') || '0', 10);
            
            userTimers[uid] = { seconds: sec, status: stat };
            updateDisplay(uid); // Hiển thị ngay lần đầu
        });
    }

    // Chạy vòng lặp đếm ngược mỗi 1 giây
    setInterval(function(){
        for (let uid in userTimers) {
            // CHỈ TRỪ TIỀN NẾU STATUS LÀ ONLINE (1)
            if (userTimers[uid].status === 1 && userTimers[uid].seconds > 0) {
                userTimers[uid].seconds--;
                updateDisplay(uid);
            }
        }
    }, 1000);

    document.addEventListener('DOMContentLoaded', initTimers);

    // ==========================================
    // SOCKET EVENTS
    // ==========================================

    // 1. Cập nhật trạng thái Online/Offline và Dừng/Chạy đồng hồ
    socket.on('user_status', function(p){ 
        const uid = p.user_id;
        const isOnline = p.is_online; // 1 hoặc 0

        // Cập nhật giao diện chữ Online/Offline
        const el = document.getElementById('status-' + uid); 
        if(el){ 
            if(isOnline == 1){ 
                el.innerHTML = '<span class="text-success fw-bold">Online</span>'; 
            } else { 
                el.innerHTML = '<span class="text-muted">Offline</span>'; 
            } 
        } 

        // Cập nhật trạng thái cho đồng hồ (để nó biết nên chạy hay dừng)
        if (userTimers[uid]) {
            userTimers[uid].status = isOnline;
        }
    });

    // 2. Nhận yêu cầu nạp tiền mới
    socket.on('new_topup_request', function(r){ 
        try{ 
            const tbody = document.getElementById('requestsBody'); 
            if(!tbody) return; 
            const tr = document.createElement('tr'); 
            tr.id = 'req-' + r.id; 
            tr.innerHTML = `<td>${r.id}</td><td>${r.username}</td><td>${r.amount}</td><td class="status-cell">${r.status}</td><td>${r.created_at}</td><td class="action-cell">` + (r.status=='pending' ? `<a href="/admin/approve_request/${r.id}">Duyệt & Nạp</a>` : '✔ Đã xử lý') + `</td>`; 
            if(tbody.firstChild) tbody.insertBefore(tr, tbody.firstChild); 
            else tbody.appendChild(tr); 
        }catch(e){console.error(e)} 
    });

    // 3. Cập nhật trạng thái yêu cầu nạp tiền (khi đã duyệt)
    socket.on('topup_request_updated', function(u){ 
        try{ 
            const row = document.getElementById('req-' + u.id); 
            if(!row) return; 
            const statusCell = row.querySelector('.status-cell'); 
            const actionCell = row.querySelector('.action-cell'); 
            if(statusCell) statusCell.innerText = u.status; 
            if(actionCell) actionCell.innerHTML = '✔ Đã xử lý'; 
        }catch(e){console.error(e)} 
    });

    // ==========================================
    // UI HELPERS (Chat & Quick Topup)
    // ==========================================
    document.addEventListener('DOMContentLoaded', function(){
      // Nút mở chat
      const chatBtn = document.getElementById('open-chat-btn');
      const chatSelect = document.getElementById('chat-select-user');
      if(chatBtn && chatSelect){
        chatBtn.addEventListener('click', function(){
          const uid = chatSelect.value;
          if(!uid) return;
          window.location = '{{ url_for("chat") }}' + '?user_id=' + encodeURIComponent(uid);
        });
      }

      // Form nạp tiền nhanh
      const quickForm = document.getElementById('quick-topup-form');
      const topupSelect = document.getElementById('topup-select-user');
      if(quickForm && topupSelect){
        quickForm.addEventListener('submit', function(e){
          const uid = topupSelect.value;
          if(!uid){ e.preventDefault(); return; }
          quickForm.action = '/admin/topup/' + encodeURIComponent(uid);
        });
      }
    });
  </script>
{% endblock %}